#!/usr/bin/env python3
"""
JSON Schema definitions and validation for vulnerability findings.
This ensures the AI responses are properly structured and validated.
"""

import json
from typing import Dict, List, Any, Optional
from enum import Enum


class Severity(str, Enum):
    """Severity levels for vulnerabilities"""
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFO = "info"


class FindingType(str, Enum):
    """Common vulnerability types"""
    WEAK_CREDENTIALS = "Weak Credentials"
    CONFIGURATION_ERROR = "Configuration Error"
    MISSING_PATCH = "Missing Security Patch"
    INFORMATION_DISCLOSURE = "Information Disclosure"
    AUTHENTICATION_BYPASS = "Authentication Bypass"
    PRIVILEGE_ESCALATION = "Privilege Escalation"
    CODE_INJECTION = "Code Injection"
    CRYPTOGRAPHIC_WEAKNESS = "Cryptographic Weakness"
    ACCESS_CONTROL = "Access Control Issue"
    NETWORK_EXPOSURE = "Network Exposure"
    OTHER = "Other"


# JSON Schema for vulnerability response
VULNERABILITY_SCHEMA = {
    "type": "object",
    "required": ["vulnerabilities"],
    "properties": {
        "vulnerabilities": {
            "type": "array",
            "items": {
                "type": "object",
                "required": [
                    "title",
                    "severity",
                    "cvss_score",
                    "finding_type",
                    "description",
                    "remediation",
                    "business_impact",
                    "affected_assets",
                    "evidence"
                ],
                "properties": {
                    "title": {
                        "type": "string",
                        "minLength": 10,
                        "maxLength": 200
                    },
                    "severity": {
                        "type": "string",
                        "enum": ["critical", "high", "medium", "low", "info"]
                    },
                    "cvss_score": {
                        "type": "number",
                        "minimum": 0.0,
                        "maximum": 10.0
                    },
                    "cve_ids": {
                        "type": "array",
                        "items": {"type": "string"}
                    },
                    "finding_type": {
                        "type": "string",
                        "minLength": 3
                    },
                    "description": {
                        "type": "string",
                        "minLength": 50
                    },
                    "remediation": {
                        "type": "string",
                        "minLength": 50
                    },
                    "business_impact": {
                        "type": "string",
                        "minLength": 30
                    },
                    "affected_assets": {
                        "type": "array",
                        "items": {"type": "string"},
                        "minItems": 1
                    },
                    "evidence": {
                        "type": "string",
                        "minLength": 10
                    },
                    "confidence_score": {
                        "type": "number",
                        "minimum": 0.0,
                        "maximum": 1.0
                    },
                    "exploitation_complexity": {
                        "type": "string",
                        "enum": ["low", "medium", "high"]
                    }
                }
            }
        }
    }
}


def validate_vulnerability_response(response: Dict[str, Any]) -> tuple[bool, Optional[str]]:
    """
    Validate a vulnerability response against the schema.
    
    Args:
        response: The response dictionary to validate
        
    Returns:
        tuple: (is_valid, error_message)
    """
    try:
        # Check if it has the required structure
        if not isinstance(response, dict):
            return False, "Response must be a dictionary"
        
        if "vulnerabilities" not in response:
            return False, "Missing 'vulnerabilities' key"
        
        if not isinstance(response["vulnerabilities"], list):
            return False, "'vulnerabilities' must be a list"
        
        # Validate each vulnerability
        for idx, vuln in enumerate(response["vulnerabilities"]):
            if not isinstance(vuln, dict):
                return False, f"Vulnerability {idx} is not a dictionary"
            
            # Check required fields
            required_fields = [
                "title", "severity", "cvss_score", "finding_type",
                "description", "remediation", "business_impact",
                "affected_assets", "evidence"
            ]
            
            for field in required_fields:
                if field not in vuln:
                    return False, f"Vulnerability {idx} missing required field: {field}"
            
            # Validate severity
            if vuln["severity"] not in ["critical", "high", "medium", "low", "info"]:
                return False, f"Vulnerability {idx} has invalid severity: {vuln['severity']}"
            
            # Validate CVSS score
            cvss = vuln["cvss_score"]
            if not isinstance(cvss, (int, float)) or cvss < 0 or cvss > 10:
                return False, f"Vulnerability {idx} has invalid CVSS score: {cvss}"
            
            # Validate string fields have content
            string_fields = ["title", "description", "remediation", "business_impact", "evidence"]
            for field in string_fields:
                if not isinstance(vuln[field], str) or len(vuln[field].strip()) < 10:
                    return False, f"Vulnerability {idx} has invalid {field}: too short or empty"
            
            # Validate affected_assets is a non-empty list
            if not isinstance(vuln["affected_assets"], list) or len(vuln["affected_assets"]) == 0:
                return False, f"Vulnerability {idx} must have at least one affected asset"
        
        return True, None
        
    except Exception as e:
        return False, f"Validation error: {str(e)}"


def get_cvss_guidance(severity: str) -> str:
    """
    Provide CVSS scoring guidance based on severity.
    
    Args:
        severity: The severity level
        
    Returns:
        str: Guidance text for CVSS scoring
    """
    guidance = {
        "critical": "CVSS 9.0-10.0: Exploitation immédiate possible avec impact majeur sur la confidentialité, l'intégrité et la disponibilité",
        "high": "CVSS 7.0-8.9: Exploitation possible avec impact significatif, nécessitant une action rapide",
        "medium": "CVSS 4.0-6.9: Impact modéré, exploitation possible mais nécessitant des conditions spécifiques",
        "low": "CVSS 0.1-3.9: Impact limité ou exploitation très complexe",
        "info": "CVSS 0.0: Information uniquement, pas de vulnérabilité exploitable"
    }
    return guidance.get(severity, "")
